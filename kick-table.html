<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_parent">
  <meta charset="UTF-8">
  <style>
    body {
      font-family: sans-serif;
      padding: 0px 10px 10px 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed;
    }
    thead {
      background-color: #663399;     /* ‡∏™‡∏µ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    }
    tbody tr:nth-child(even) {
      background-color: #E6E6FA;     /* ‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏π‡πà */
    }
    tbody tr:nth-child(odd) {
      background-color: #ffffff;     /* ‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏µ‡πà */
    }
    .today-row {
      background-color: #FFF3CD !important; /* ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ */
      font-weight: bold;
    }
    thead th {
      color: #ffffff; /* ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏Ç‡πâ‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.2em;
      text-align: center;
    }
    th.date-header, th.total-header {
      font-size: 1em;
      font-weight: bold;
    }
    th span {
      display: block;
      font-size: 0.6em;
      color: #ffffff;
    }
    button {
      padding: 1px 1px;
      font-size: 11px;
    }
    :root{
      --controls-gap: 5px;   /* ‡πÅ‡∏Å‡πâ‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á */
    }
    .controls{
      display:flex;
      justify-content:flex-start;
      align-items:center;
      gap:var(--controls-gap);
      margin-bottom:10px;
    }
    tbody td.total-column {
  	  background-color: #ffdddd;
	}
    .count {
      font-size: 10px;
    }
    /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏ß‡∏° */
    td.sum {
      font-size: 20px;
    }
    #monthYear {
      font-size: 12px;
	}
    td:first-child {
      font-size: 10px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
	}
    .counter-btn {
  	  padding: 0px 0px;
  	  font-size: 6px;
  	  line-height: 1;
	}
    /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 5 */
    th:nth-child(5),
    td:nth-child(5) {
      width: 12%;
    }
	th:nth-child(1),
    td:nth-child(1) {
      width: 13%;
    }
    /* ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 1-4 ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
    th:nth-child(2),
    td:nth-child(2),
    th:nth-child(3),
    td:nth-child(3),
    th:nth-child(4),
    td:nth-child(4) {
      width: 25%;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button onclick="changeMonth(-1)">‚¨Ö ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</button>
    <h3 id="monthYear"></h3>
    <button onclick="changeMonth(1)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°</button>
  </div>

  <table id="logTable">
    <thead>
      <tr>
        <th class="date-header">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
        <th>‡πÄ‡∏ä‡πâ‡∏≤<br><span>(6:00-12:00)</span></th>
        <th>‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á<br><span>(12:00-18:00)</span></th>
        <th>‡πÄ‡∏¢‡πá‡∏ô<br><span>(18:00-24:00)</span></th>
        <th class="total-header">‡∏£‡∏ß‡∏°</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const tableBody = document.querySelector('#logTable tbody');
    const monthYearDisplay = document.getElementById('monthYear');
    let currentDate = new Date();

    function daysInMonth(year, month) {
      return new Date(year, month + 1, 0).getDate();
    }

    function renderTable(year, month) {
      tableBody.innerHTML = '';
      const days = daysInMonth(year, month);
      monthYearDisplay.textContent = new Date(year, month).toLocaleString('th-TH', {
        month: 'long',
        year: 'numeric'
      });
      const today = new Date();
      for (let day = 1; day <= days; day++) {
        const row = document.createElement('tr');
        const date = new Date(year, month, day);
        const dateStr = date.toLocaleDateString('th-TH', {
          day: '2-digit',
          month: '2-digit',

        });

        row.innerHTML = `
          <td>${dateStr}</td>
          ${[0,1,2].map(i => `
            <td>
              <button class="counter-btn" onclick="updateCount(this, -1)">-</button>
              <span class="count">0</span>
              <button class="counter-btn" onclick="updateCount(this, 1)">+</button>
            </td>
          `).join('')}
          <td class="total-column sum">0</td>   <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° class total-column -->
        `;

        tableBody.appendChild(row);
      }
    }

    function updateCount(button, delta) {
      const countSpan = button.parentElement.querySelector('.count');
      let value = parseInt(countSpan.textContent);
      value = Math.max(0, value + delta);
      countSpan.textContent = value;

      // Update sum
      const row = button.closest('tr');
      const counts = row.querySelectorAll('.count');
      const total = [...counts].reduce((sum, c) => sum + parseInt(c.textContent), 0);
      row.querySelector('.sum').textContent = total;
    }

    function changeMonth(offset) {
      currentDate.setMonth(currentDate.getMonth() + offset);
      renderTable(currentDate.getFullYear(), currentDate.getMonth());
    }

    // Initial render
    renderTable(currentDate.getFullYear(), currentDate.getMonth());
	  
    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å parent (Wix Velo)
    window.addEventListener('message', (event) => {
  	const msg = event.data;
  	if (msg.type === 'loadData') {
    	    populateTable(msg.payload);  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≤‡∏Å Google Sheet
  	}
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function populateTable(data) {
  	if (!data || !Array.isArray(data)) return;
  	const rows = tableBody.querySelectorAll('tr');
  	rows.forEach(row => {
    	    const dateCell = row.cells[0].textContent.trim();
    	    const record = data.find(item => item.date === dateCell);
    	    if (record) {
      		for(let i=0; i<3; i++) {
        	    const countSpan = row.cells[i+1].querySelector('.count');
        	    countSpan.textContent = record[`col${i+2}`] || 0;
      		}
      		const totalCell = row.cells[4];
      		const total = (record.col2||0) + (record.col3||0) + (record.col4||0);
      		totalCell.textContent = total;
    	    }
  	});
    }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateCount ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö Wix ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    function updateCount(button, delta) {
  	const countSpan = button.parentElement.querySelector('.count');
  	let value = parseInt(countSpan.textContent);
  	value = Math.max(0, value + delta);
  	countSpan.textContent = value;

  	// Update sum
  	const row = button.closest('tr');
  	const counts = row.querySelectorAll('.count');
  	const total = [...counts].reduce((sum, c) => sum + parseInt(c.textContent), 0);
  	row.querySelector('.sum').textContent = total;

  	// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö Wix ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  	const date = row.cells[0].textContent.trim();
  	const dataToSend = {
    	    type: 'dataChanged',
	    payload: {
      		date: date,
      		username: '',  // Wix ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏≠‡∏á, ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô postMessage ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î
      		col2: parseInt(row.cells[1].querySelector('.count').textContent),
      		col3: parseInt(row.cells[2].querySelector('.count').textContent),
      		col4: parseInt(row.cells[3].querySelector('.count').textContent),
      		total: total
    	    }
  	};
  	parent.postMessage(dataToSend, '*');
    }


	  
	  function updateCount(button, delta) {
  const countSpan = button.parentElement.querySelector('.count');
  let value = parseInt(countSpan.textContent);
  value = Math.max(0, value + delta);
  countSpan.textContent = value;

  const row = button.closest('tr');
  const counts = row.querySelectorAll('.count');
  const total = [...counts].reduce((sum, c) => sum + parseInt(c.textContent), 0);
  row.querySelector('.sum').textContent = total;

  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö
  const date = row.cells[0].textContent.trim();
  const dataToSend = {
    type: 'dataChanged',
    payload: {
      date: date,
      username: 'test-debug', // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
      col2: parseInt(row.cells[1].querySelector('.count').textContent),
      col3: parseInt(row.cells[2].querySelector('.count').textContent),
      col4: parseInt(row.cells[3].querySelector('.count').textContent),
      total: total
    }
  };

  console.log('üì§ sending to parent:', dataToSend); // <== ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏´‡∏°
  parent.postMessage(dataToSend, '*');
}


	  
  </script>
</body>
</html>
